<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Codenames Board</title>
<style>
  body {
    margin: 20px; max-width: 900px; margin-left: auto; margin-right: auto; font-family: Arial, sans-serif;
  }

  /* Hide role colors initially */
  td.red-bg, td.blue-bg, td.neutral-bg, td.assassin-bg {
    background-color: transparent !important;
    color: black !important;
  }

  /* Show role colors only when .show-map present */
  body.show-map td.red-bg,
  td.red-bg.revealed {
    background-color: crimson !important;
    color: white !important;
  }
  body.show-map td.blue-bg,
  td.blue-bg.revealed {
    background-color: navy !important;
    color: white !important;
  }
  body.show-map td.neutral-bg,
  td.neutral-bg.revealed {
    background-color: #f0f0f0 !important;
    color: black !important;
  }
  body.show-map td.assassin-bg,
  td.assassin-bg.revealed {
    background-color: black !important;
    color: white !important;
  }

  /* Hide interface contents */
  body.hide-interface #header-container,
  body.hide-interface #player-management {
    display: none;
  }

  /* Disable click on reveal buttons & gray when map hidden */
  body.map-hidden button.reveal-btn {
    pointer-events: none;
    cursor: default;
    color: black !important;
    font-weight: bold !important;
    filter: none !important;
    text-shadow: none !important;
  }

  button {
    font-size: 10px;
    padding: 0 6px;
    height: 20px;
    line-height: 20px;
    min-width: 40px;
    border-radius: 2px;
    margin: 0;
    border: 1px solid #ccc;
    font-weight: normal;
    cursor: pointer;
    box-sizing: border-box;
    white-space: nowrap;
  }

  table {
    border-collapse: collapse;
    width: 100%;
  }

  td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
    vertical-align: middle;
    width: 140px;
    height: 70px;
    font-weight: bold;
    font-size: 16px;
    user-select: none;
  }

  small {
    font-size: 10px;
    color: darkgray;
  }
</style>
</head>
<body>
<button id="toggle-map-btn">Show Map</button>
<button id="toggle-interface-btn">Hide Interface</button>

<div id="header-container">
  <h1>Codenames</h1>

  <p>First team: <span class="{{ first_team }}">{{ first_team|capitalize }}</span> (has 9 words to find)</p>
  <p>
    Remaining words -
    <span style="color: crimson; font-weight: bold;">Red: {{ red_remaining }}</span>,
    <span style="color: navy; font-weight: bold;">Blue: {{ blue_remaining }}</span>
  </p>

  <div id="controls">
    <form method="post" action="/reset" style="display:inline;" onsubmit="return confirmReset()">
      <button type="submit">Reset</button>
    </form>

    <form method="post" action="/set_language" style="display:inline; margin-left: 20px;">
      <label for="language-select">Main language:</label>
      <select name="language" id="language-select" onchange="this.form.submit()">
        <option value="english" {% if main_language == 'english' %}selected{% endif %}>English</option>
        <option value="greek" {% if main_language == 'greek' %}selected{% endif %}>Greek</option>
      </select>
    </form>
  </div>

  <button id="toggle-players-btn" style="margin-top: 10px; margin-bottom: 10px;">
    Hide Player Management
  </button>

  <div id="player-management">
    <hr />
    <h3>Players Management</h3>

    <div style="display:flex; gap: 50px;">
      <div>
        <h4 style="color: crimson;">Red Team</h4>
        <form method="post" action="/add_player" style="margin-bottom: 10px;">
          <input type="hidden" name="team" value="red" />
          <input type="text" name="name" placeholder="Add Red player" required />
          <button type="submit">Add</button>
        </form>
        <ul>
          {% for player in players.red %}
          <li>{{ player }}</li>
          {% endfor %}
        </ul>
      </div>

      <div>
        <h4 style="color: navy;">Blue Team</h4>
        <form method="post" action="/add_player" style="margin-bottom: 10px;">
          <input type="hidden" name="team" value="blue" />
          <input type="text" name="name" placeholder="Add Blue player" required />
          <button type="submit">Add</button>
        </form>
        <ul>
          {% for player in players.blue %}
          <li>{{ player }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <form method="post" action="/randomize_players" style="margin-top: 10px;">
      <button type="submit">Randomly allocate all players between teams</button>
    </form>

    <form method="post" action="/clear_players" style="margin-top: 5px;">
      <button type="submit">Clear all players</button>
    </form>

    <hr />
  </div>
</div>

<table>
  {% for cell in board %}
    {% if loop.index0 % 5 == 0 %}
      <tr>
    {% endif %}
    <td class="{{ cell.role }}-bg {% if cell.revealed %}revealed{% endif %}">
      {% if cell.revealed %}
        <span style="visibility:hidden;">
          {{ cell.word_en }}<br /><small>{{ cell.word_gr }}</small>
        </span>
      {% else %}
        <form method="post" action="/reveal" style="margin:0;">
          <input type="hidden" name="idx" value="{{ loop.index0 }}" />
          <button class="reveal-btn" type="submit" style="width:100%;height:100%;border:none;background:none;padding:0;font-weight:bold;font-size:16px;color:inherit;">
            {% if main_language == 'english' %}
            {{ cell.word_en }}<br /><small>{{ cell.word_gr }}</small>
            {% else %}
            {{ cell.word_gr }}<br /><small>{{ cell.word_en }}</small>
            {% endif %}
          </button>
        </form>
      {% endif %}
    </td>
    {% if loop.index0 % 5 == 4 %}
      </tr>
    {% endif %}
  {% endfor %}
</table>

<script>
  function confirmReset() {
    return confirm("Are you sure you want to reset the game? This will start a new board.");
  }

  // Player management toggle
  const togglePlayersBtn = document.getElementById("toggle-players-btn");
  const playersDiv = document.getElementById("player-management");

  const playersVisible = localStorage.getItem("playersVisible");
  if (playersVisible === "hidden") {
    playersDiv.style.display = "none";
    togglePlayersBtn.textContent = "Show Player Management";
  }

  togglePlayersBtn.onclick = () => {
    if (playersDiv.style.display === "none") {
      playersDiv.style.display = "block";
      togglePlayersBtn.textContent = "Hide Player Management";
      localStorage.setItem("playersVisible", "visible");
    } else {
      playersDiv.style.display = "none";
      togglePlayersBtn.textContent = "Show Player Management";
      localStorage.setItem("playersVisible", "hidden");
    }
  };

  // Map and Interface toggles with enabling/disabling word clicking
  const body = document.body;
  const toggleMapBtn = document.getElementById("toggle-map-btn");
  const toggleInterfaceBtn = document.getElementById("toggle-interface-btn");

  let mapVisible = localStorage.getItem("mapVisible") === "true";
  let interfaceVisible = localStorage.getItem("interfaceVisible") !== "false";

  function updateMapUI() {
    if (mapVisible) {
      body.classList.remove("map-hidden");
      body.classList.add("show-map");
      toggleMapBtn.textContent = "Hide Map";
      localStorage.setItem("mapVisible", true);
    } else {
      body.classList.add("map-hidden");
      body.classList.remove("show-map");
      toggleMapBtn.textContent = "Show Map";
      localStorage.setItem("mapVisible", false);
    }
  }

  function updateInterfaceUI() {
    if (interfaceVisible) {
      body.classList.remove("hide-interface");
      toggleInterfaceBtn.textContent = "Hide Interface";
      localStorage.setItem("interfaceVisible", true);
    } else {
      body.classList.add("hide-interface");
      toggleInterfaceBtn.textContent = "Show Interface";
      localStorage.setItem("interfaceVisible", false);
    }
  }

  toggleMapBtn.onclick = () => {
    mapVisible = !mapVisible;
    updateMapUI();
  };

  toggleInterfaceBtn.onclick = () => {
    interfaceVisible = !interfaceVisible;
    updateInterfaceUI();
  };

  // Initialize UI state on load
  updateMapUI();
  updateInterfaceUI();

  // WebSocket for live reload
  let socket;
  let reconnectDelay = 1000;

  function createWebSocket() {
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    socket = new WebSocket(`${protocol}://${window.location.host}/ws`);

    socket.onopen = () => {
      reconnectDelay = 1000;
      console.log("WebSocket connected");
    };

    socket.onmessage = (event) => {
      if (event.data === "reload") {
        console.log("Reload message received, refreshing...");
        window.location.reload();
      } else if (event.data === "pong") {
        // pong for keepalive
      }
    };

    socket.onclose = () => {
      console.warn(`WebSocket closed, reconnecting in ${reconnectDelay}ms...`);
      setTimeout(() => {
        reconnectDelay = Math.min(reconnectDelay * 2, 30000);
        createWebSocket();
      }, reconnectDelay);
    };

    socket.onerror = (event) => {
      console.error("WebSocket error:", event);
      socket.close();
    };

    // Send ping every 15 sec
    setInterval(() => {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send("ping");
      }
    }, 15000);
  }

  createWebSocket();
</script>
</body>
</html>
